# 如何管理大量TCP连接

本章的目标是介绍如何管理大量的TCP连接（UDP要用好真不简单，功力有限，抛开不谈），思路如下：

- 先说挑战，从几个经典问题看起。
- 再说理论，看Linux操作系统几种经典的I/O模型是如何解决这些问题的
- 然后说下代码实现
- 最后会深入探讨下万、十万和百万级别连接管理的架构

## 经典问题：C10K和C10M

### 引言

我印象中小学（2003年）时代一个月才有1次的计算机打字课（进去还要换拖鞋，也是很奇怪），是用的大头机和windows98系统：

![大头机](../images/pc_1990.jpg)

到初中年代（2008），县城里的网吧也还有许多电脑是这种大头机（辐射非常大，玩一会头晕眼花），然后慢慢的才有液晶显示器，直到大学才有自己的第一款笔记本（2010）。

也是从2010年后，自己各种折腾电脑，重装系统，到自己工作，才开始关注CPU，i3、i5和i7，甚至最近2020年新款的mac pro的i9处理器，从单核到双核到4核8线程等等。

计算机飞速发展，现在一台普通的笔记本甚至智能手机都能媲美20世纪的服务器了。【PK图，后续添加】

大学时代，我在i3配置的笔记本上用C#实现了一个windows tcp server，一开始只能支持几百个连接（客户端启动和退出一频繁，服务就崩溃），然后使用了IOCP的技术，实现了几千个连接的支持（受限于笔记本）。直到工作，任意找一台台式机，用Linux写一个epoll服务端，就可以实现上万的连接支持，所以现在C10K（单机支持10*1000个连接）已经不在是问题了。

### C10K

简单来说，C10K就是指单机如何支持1万个（10*1000）连接，主要是在互联网的早期，Web服务器在硬件有限的情况下，如何能支持更高的并发（众所周知HTTP协议是基于TCP之上的，所以需要建立连接）。

虽然目前服务器性能越来越高，但是如果方法不对（Linux下如果使用select I/O复用模型，则默认最大只能支持1024个连接，更多就需要修改内核并重新编译了），也是做不到1万个连接的支持的。

左耳朵耗子大叔的专栏里面有提到，提出这个问题的人叫丹·凯格尔（Dan Kegel），目前在 Google 任职。可以阅读一下这篇文章了解下这个问题：[The C10K problem](http://www.kegel.com/c10k.html)([翻译版](https://www.oschina.net/translate/c10k))

这个问题的本质，引用左耳朵耗子大叔的话来解释：

> C10K 问题本质上是操作系统处理大并发请求的问题。对于 Web 时代的操作系统而言，客户端过来的大量的并发请求，需要创建相应的服务进程或线程。这些进程或线程多了，导致数据拷贝频繁（缓存 I/O、内核将数据拷贝到用户进程空间、阻塞）， 进程 / 线程上下文切换消耗大，从而导致资源被耗尽而崩溃。这就是 C10K 问题的本质。
>
> 了解这个问题，并了解操作系统是如何通过多路复用的技术来解决这个问题的，有助于你了解各种 I/O 和异步模型，这对于你未来的编程和架构能力是相当重要的。

### C10M

更近一步，单机如何支持千万级（10\*1000*1000）连接可以看一下这篇文章：[The Secret To 10 Million Concurrent Connections -The Kernel Is The Problem, Not The Solution](http://highscalability.com/blog/2013/5/13/the-secret-to-10-million-concurrent-connections-the-kernel-i.html)

## 理论基础



### 延伸阅读
#### 关于共享内存
#### 关于用户态TCP
#### windows下的I/O复用：IOCP

## 实现

### 数据模型
#### connect, user模型

### C++实现
### Go实现
### Java实现

## 改进

### 万级别的架构：单机

### 十万级别的架构：多机

### 百万级别的架构：集群

### 万到百万的挑战

#### 三高：高性能、高可用、高并发

#### 高可用技术

#### 高并发技术

- 并发编程
- 协程
- 无锁编程
- 缓存技术
- ……

#### 连接"桶"

#### 分布式集群技术